// Generated by CoffeeScript 1.3.3
(function() {

  namespace('timer.views');

  namespace('timer.models');

  namespace('timer.collections');

  namespace('timer.router');

  $(function() {
    timer.router = new timer.router.MainRouter();
    return Backbone.history.start({
      pushState: false
    });
  });

  /* --------------------------------------------
       Begin Slip.coffee
  --------------------------------------------
  */


  timer.models.Slip = Backbone.Model.extend({
    defaults: {
      'running': false,
      'description': '',
      'duration': 0
    }
  });

  /* --------------------------------------------
       Begin Slips.coffee
  --------------------------------------------
  */


  timer.collections.Slips = Backbone.Collection.extend({
    url: "" + window.BASE_URL + "/slips/",
    model: timer.models.Slip,
    initialize: function() {
      var _this = this;
      this.loadingDfd = new $.Deferred();
      return this.on('reset', function() {
        return _this.loadingDfd.resolve();
      });
    }
  });

  /* --------------------------------------------
       Begin SlipsList.coffee
  --------------------------------------------
  */


  timer.views.SlipList = Backbone.View.extend({
    tagName: 'section',
    className: 'slips-list',
    initialize: function() {
      this.template = timer.templates.getTemplate('slips-list');
      return timer.slips.on('reset', this.render, this);
    },
    transitionIn: function() {
      var dfd;
      dfd = new $.Deferred();
      setTimeout(dfd.resolve, 1000);
      this.$el.addClass('animated fadeIn');
      return dfd.promise();
    },
    transitionOut: function() {
      var dfd;
      dfd = new $.Deferred();
      setTimeout(dfd.resolve, 1000);
      this.$el.addClass('fadeOut');
      return dfd.promise();
    },
    render: function() {
      var template;
      template = _.template(this.template);
      this.$el.html(template({
        slips: timer.slips.first(5)
      }));
      this.transitionIn();
      return this;
    }
  });

  /* --------------------------------------------
       Begin AddSlip.coffee
  --------------------------------------------
  */


  timer.views.AddSlip = Backbone.View.extend({
    tagName: 'section',
    className: 'add-slip',
    events: {
      'click button': 'addNewSlip'
    },
    initialize: function() {
      return this.template = timer.templates.getTemplate('add-slip');
    },
    transitionIn: function() {
      var dfd;
      dfd = new $.Deferred();
      setTimeout(dfd.resolve, 400);
      this.$el.addClass('animated fadeIn');
      return dfd.promise();
    },
    addNewSlip: function() {
      var description;
      description = prompt('Enter slip name');
      if (description === null) {
        return;
      }
      if (description === '') {
        return alert('You need to enter a slip name');
      }
      if (timer.slips.where({
        'description': description
      }) > 0) {
        return alert('A slip with that name already exists');
      }
      timer.slips.add({
        'description': description,
        'running': true
      });
      return timer.router.navigate("/track/" + (escape(description)), true);
    },
    render: function() {
      var template;
      template = _.template(this.template);
      this.$el.html(template({}));
      this.transitionIn();
      return this;
    },
    transitionOut: function() {
      var dfd;
      dfd = new $.Deferred();
      setTimeout(dfd.resolve, 400);
      this.$el.addClass('fadeOut');
      return dfd.promise();
    }
  });

  /* --------------------------------------------
       Begin TrackTime.coffee
  --------------------------------------------
  */


  timer.views.TrackTime = Backbone.View.extend({
    tagName: 'section',
    className: 'track-time',
    initialize: function() {
      this.template = timer.templates.getTemplate('track-time');
      this.model.on('change:running', this.toggleTimer, this);
      return this.startTrackingTime();
    },
    toggleTimer: function(model, running) {
      return this.startTrackingTime()(running ? void 0 : this.stopTrackingTime());
    },
    startTrackingTime: function() {
      return log("Start tracking time for ", this.model.toJSON());
    },
    stopTrackingTime: function() {
      return log("Stop tracking time.");
    },
    transitionIn: function() {
      var dfd;
      dfd = new $.Deferred();
      setTimeout(dfd.resolve, 400);
      this.$el.addClass('animated fadeIn');
      return dfd.promise();
    },
    transitionOut: function() {
      var dfd;
      dfd = new $.Deferred();
      setTimeout(dfd.resolve, 400);
      this.$el.addClass('fadeOut');
      this.model.set('running', false);
      return dfd.promise();
    },
    render: function() {
      var template;
      template = _.template(this.template);
      this.$el.html(template(this.model.toJSON()));
      this.transitionIn();
      return this;
    }
  });

  /* --------------------------------------------
       Begin Timer.coffee
  --------------------------------------------
  */


  timer.views.Timer = Backbone.View.extend({
    tagName: 'article',
    className: 'timer',
    initialize: function() {
      this.addSlipView = new timer.views.AddSlip();
      this.slipList = new timer.views.SlipList();
      return this.render();
    },
    trackTime: function(model) {
      var _this = this;
      if (this.addSlipView) {
        return this.addSlipView.transitionOut().done(function() {
          return _this.trackTimeView = new timer.views.TrackTime({
            model: model
          });
        });
      } else {
        return this.trackTimeView = new timer.views.TrackTime({
          model: model
        });
      }
    },
    reset: function() {
      var _this = this;
      if (this.trackTimeView) {
        return this.trackTimeView.transitionOut().done(function() {
          _this.trackTimeView.destroy();
          return _this.addSlipView.transitionIn();
        });
      } else {
        return this.addSlipView.transitionIn();
      }
    },
    render: function() {
      this.$el.append(this.addSlipView.render().el);
      this.$el.append(this.slipList.render().el);
      $('#container').html(this.$el);
      return this;
    }
  });

  /* --------------------------------------------
       Begin MainRouter.coffee
  --------------------------------------------
  */


  timer.router.MainRouter = Backbone.Router.extend({
    routes: {
      'track/:term': 'startTimer',
      'reset/:term': 'resetTimer',
      '': 'stopTimer'
    },
    initialize: function() {
      timer.templates = new TemplateController();
      timer.templates.addTemplate('track-time');
      timer.templates.addTemplate('add-slip');
      timer.templates.addTemplate('slips-list');
      timer.slips = new timer.collections.Slips();
      timer.view = new timer.views.Timer();
      return timer.slips.fetch();
    },
    startTimer: function(desc) {
      var _this = this;
      return timer.slips.loadingDfd.done(function() {
        var model;
        model = timer.slips.where({
          'description': unescape(desc)
        })[0];
        if (!model) {
          return _this.navigate('/', true);
        }
        timer.view.trackTime(model);
        if (model.isNew()) {
          return model.save();
        }
      });
    },
    stopTimer: function(desc) {
      log("Stopping timer for " + desc);
      return timer.view.reset();
    },
    resetTimer: function(desc) {
      return log("Resetting timer for " + desc);
    }
  });

}).call(this);
